name: .NET 7 CI/CD to Windows VM

on:
  push:
    branches: [ "master" ]

jobs:
  build-and-deploy:
    runs-on: windows-latest

    steps:
    # Checkout repo
    - name: Checkout code
      uses: actions/checkout@v3

    # Setup .NET 7
    - name: Setup .NET 7
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: '7.0.x'

    # Restore dependencies
    - name: Restore
      run: dotnet restore

    # Build project
    - name: Build
      run: dotnet build --configuration Release --no-restore

    # Publish project
    - name: Publish
      run: dotnet publish --configuration Release --output publish

    # Deploy to VM
    - name: Deploy to Windows VM
      uses: appleboy/powershell-action@v0.2.0
      with:
        host: ${{ secrets.VM_HOST }}
        username: ${{ secrets.VM_USER }}
        password: ${{ secrets.VM_PASSWORD }}
        script: |
          Stop-Website -Name "Default Web Site"
          
          Remove-Item -Recurse -Force "C:\inetpub\wwwroot\myapp\*"
          
          Copy-Item -Path "${{ github.workspace }}\publish\*" -Destination "C:\inetpub\wwwroot\myapp" -Recurse
          
          Start-Website -Name "Default Web Site"
