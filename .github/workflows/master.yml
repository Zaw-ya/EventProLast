name: .NET 7 CI/CD to Windows VM

on:
  push:
    branches: [ "master" ]

jobs:
  build-and-deploy:
    runs-on: windows-latest

    steps:
    # Checkout repo
    - name: Checkout code
      uses: actions/checkout@v3

    # Setup .NET 7
    - name: Setup .NET 7
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: '7.0.x'

    # Restore dependencies
    - name: Restore
      run: dotnet restore

    # Build project
    - name: Build
      run: dotnet build --configuration Release --no-restore

    # Publish project
    - name: Publish
      run: dotnet publish --configuration Release --output publish

    # Deploy to Windows VM via WinRM
    - name: Deploy to VM
      shell: pwsh
      run: |
        $vmHost = "${{ secrets.VM_HOST }}"
        $vmUser = "${{ secrets.VM_USER }}"
        $vmPassword = "${{ secrets.VM_PASSWORD }}" | ConvertTo-SecureString -AsPlainText -Force
        $cred = New-Object System.Management.Automation.PSCredential ($vmUser, $vmPassword)

        $session = New-PSSession -ComputerName $vmHost -Credential $cred -Authentication Default

        Invoke-Command -Session $session -ScriptBlock {
            Import-Module WebAdministration

            Stop-Website -Name "Default Web Site"

            Remove-Item -Recurse -Force "C:\inetpub\wwwroot\myapp\*"

            Copy-Item -Path "C:\github\workspace\publish\*" -Destination "C:\inetpub\wwwroot\myapp" -Recurse

            Start-Website -Name "Default Web Site"
        }

        # اغلاق الـ session
        Remove-PSSession $session
