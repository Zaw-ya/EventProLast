@{
    Layout = "~/Views/Shared/_Admin.cshtml";
    var chartLabels = ViewBag.ChartLabels as List<string>;
    var chartData = ViewBag.ChartData as List<int>;
    var clientCount = ViewBag.ClientCount != null ? (int)ViewBag.ClientCount : 0;
    var gkCount = ViewBag.GatekeeperCount != null ? (int)ViewBag.GatekeeperCount : 0;
    var userCount = ViewBag.UsersCount != null ? (int)ViewBag.UsersCount : 0;
    var otherCount = userCount - (clientCount + gkCount);
}

<section class="content">
    <div class="container-fluid">
        <!-- Small boxes (Stat box) -->
        <div class="row pt-3">
            <div class="col-lg-3 col-6">
                <!-- small box -->
                <div class="small-box bg-info">
                    <div class="inner">
                        <h3>@(ViewBag.EventsCount ?? 0)</h3>
                        <p>Total Events</p>
                    </div>
                    <div class="icon">
                        <i class="fas fa-calendar-alt"></i>
                    </div>
                    <a href="~/admin/events" class="small-box-footer">More info <i class="fas fa-arrow-circle-right"></i></a>
                </div>
            </div>
            <!-- ./col -->
            <div class="col-lg-3 col-6">
                <!-- small box -->
                <div class="small-box bg-success">
                    <div class="inner">
                        <h3>@(ViewBag.UsersCount ?? 0)</h3>
                        <p>Total Users</p>
                    </div>
                    <div class="icon">
                        <i class="fas fa-users"></i>
                    </div>
                    <a href="~/admin/users" class="small-box-footer">More info <i class="fas fa-arrow-circle-right"></i></a>
                </div>
            </div>
            <!-- ./col -->
            <div class="col-lg-3 col-6">
                <!-- small box -->
                <div class="small-box bg-warning">
                    <div class="inner">
                        <h3>@clientCount</h3>
                        <p>Clients</p>
                    </div>
                    <div class="icon">
                        <i class="fas fa-user-tie"></i>
                    </div>
                    <a href="~/admin/users?type=client" class="small-box-footer">More info <i class="fas fa-arrow-circle-right"></i></a>
                </div>
            </div>
            <!-- ./col -->
            <div class="col-lg-3 col-6">
                <!-- small box -->
                <div class="small-box bg-danger">
                    <div class="inner">
                        <h3>@gkCount</h3>
                        <p>Gatekeepers</p>
                    </div>
                    <div class="icon">
                        <i class="fas fa-user-shield"></i>
                    </div>
                    <a href="~/admin/users?type=gatekeeper" class="small-box-footer">More info <i class="fas fa-arrow-circle-right"></i></a>
                </div>
            </div>
            <!-- ./col -->
        </div>
        <!-- /.row -->

        <!-- Events Tabs Section -->
        <div class="row">
            <div class="col-12">
                <div class="card card-primary card-outline card-tabs">
                    <div class="card-header p-0 pt-1 border-bottom-0">
                        <ul class="nav nav-tabs" id="custom-tabs-three-tab" role="tablist">
                            <li class="nav-item">
                                <a class="nav-link active" id="tabs-upcoming-tab" data-toggle="pill" href="#tabs-upcoming" role="tab" aria-controls="tabs-upcoming" aria-selected="true">
                                    <i class="far fa-calendar-plus mr-2"></i>Upcoming Events
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" id="tabs-inprogress-tab" data-toggle="pill" href="#tabs-inprogress" role="tab" aria-controls="tabs-inprogress" aria-selected="false">
                                    <i class="fas fa-spinner mr-2"></i>In Progress
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" id="tabs-past-tab" data-toggle="pill" href="#tabs-past" role="tab" aria-controls="tabs-past" aria-selected="false">
                                    <i class="far fa-calendar-check mr-2"></i>Recent Past Events
                                </a>
                            </li>
                        </ul>
                    </div>
                    <div class="card-body">
                        <div class="tab-content" id="custom-tabs-three-tabContent">
                            <div class="tab-pane fade show active" id="tabs-upcoming" role="tabpanel" aria-labelledby="tabs-upcoming-tab">
                                @await Html.PartialAsync("_EventListPartial", (List<EventPro.DAL.Models.Events>)ViewBag.UpcomingEvents)
                            </div>
                            <div class="tab-pane fade" id="tabs-inprogress" role="tabpanel" aria-labelledby="tabs-inprogress-tab">
                                @await Html.PartialAsync("_EventListPartial", (List<EventPro.DAL.Models.Events>)ViewBag.InProgressEvents)
                            </div>
                            <div class="tab-pane fade" id="tabs-past" role="tabpanel" aria-labelledby="tabs-past-tab">
                                @await Html.PartialAsync("_EventListPartial", (List<EventPro.DAL.Models.Events>)ViewBag.PastEvents)
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Section -->
        <div class="row">
            <div class="col-md-8">
                <div class="card card-primary card-outline">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="far fa-chart-bar"></i>
                            Events Overview (@DateTime.Now.Year)
                        </h3>
                         <div class="card-tools">
                            <button type="button" class="btn btn-tool" data-card-widget="collapse">
                                <i class="fas fa-minus"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                         <canvas id="eventsBarChart" style="min-height: 350px; height: 350px; max-height: 350px; max-width: 100%;"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                 <div class="card card-primary card-outline">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-chart-pie"></i>
                            User Distribution
                        </h3>
                        <div class="card-tools">
                            <button type="button" class="btn btn-tool" data-card-widget="collapse">
                                <i class="fas fa-minus"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <canvas id="usersDonutChart" style="min-height: 350px; height: 350px; max-height: 350px; max-width: 100%;"></canvas>
                    </div>
                 </div>
            </div>
        </div>

      
    </div>
</section>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        $(function () {
            // --- Events Bar Chart ---
            var barChartCanvas = $('#eventsBarChart').get(0).getContext('2d');
            var chartLabels = @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(ViewBag.ChartLabels))
            var chartData = @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(ViewBag.ChartData))

            var barChartData = {
                labels: chartLabels,
                datasets: [
                    {
                        label: 'Events Created',
                        backgroundColor: 'rgba(60,141,188,0.9)',
                        borderColor: 'rgba(60,141,188,0.8)',
                        pointRadius: false,
                        pointColor: '#3b8bba',
                        pointStrokeColor: 'rgba(60,141,188,1)',
                        pointHighlightFill: '#fff',
                        pointHighlightStroke: 'rgba(60,141,188,1)',
                        data: chartData
                    }
                ]
            }

            var barChartOptions = {
                responsive: true,
                maintainAspectRatio: false,
                datasetFill: false,
                scales: {
                    y: {
                        beginAtZero: true,
                         ticks: {
                            stepSize: 1
                        }
                    }
                }
            }

            new Chart(barChartCanvas, {
                type: 'bar',
                data: barChartData,
                options: barChartOptions
            });

            // --- Users Donut Chart ---
            var donutChartCanvas = $('#usersDonutChart').get(0).getContext('2d');
            var donutData = {
                labels: [
                    'Clients',
                    'Gatekeepers',
                    'Others'
                ],
                datasets: [
                    {
                        data: [@clientCount, @gkCount, @otherCount],
                        backgroundColor: ['#f39c12', '#f56954', '#00c0ef'],
                    }
                ]
            }
            var donutOptions = {
                maintainAspectRatio: false,
                responsive: true,
            }

             new Chart(donutChartCanvas, {
                type: 'doughnut',
                data: donutData,
                options: donutOptions
            });

        });
    </script>
}