@model IEnumerable<EventPro.DAL.Models.VwEvents>
@{
    ViewData["Title"] = "Events";
    Layout = "~/Views/Shared/_Admin.cshtml";
}

<section class="content">
    <div class="container-fluid">
        @if (TempData["message"] != null)
        {
            <div class="alert alert-danger" role="alert">
                <strong>Error!</strong> @TempData["message"]
            </div>
        }

        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Events List</h3>
                @if (!User.IsInRole("Agent") && !User.IsInRole("Accounting"))
                {
                    <div class="col-md-2" style="float: right;">
                        <a href="~/admin/_events"
                           class="btn btn-primary btn-sm"
                           style="width:100%; margin-bottom:0px;">
                            Create Events
                        </a>
                    </div>
                }
            </div>
                <table id="EventsTable" class="table table-bordered table-striped text-center">
                    <thead>
                        <tr>
                            <th style="display:none;">Id</th>
                            <th>Id</th>
                            <th>Linked To</th>
                            <th>Title</th>
                            <th>Start Date</th>
                            <th>End Date</th>
                            <th>Venue</th>
                            <th>Created On</th>
                            <th>Created By</th>
                            <th>Status</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (Model != null)
                        {
                            foreach (var item in Model)
                            {
                                var eventType = "in-progress";
                                if (item.EventTo < DateTime.Now)
                                {
                                    eventType = "past";
                                }
                                else if (item.EventFrom > DateTime.Now)
                                {
                                    eventType = "upcoming";
                                }

                                <tr>
                                    <td style="display:none;">@item.Id</td>
                                    <td>@item.Id</td>
                                    <td>@(item.LinkedEvent.HasValue ? item.LinkedEvent.Value.ToString() : "--")</td>
                                    <td>@item.EventTitle</td>
                                    <td>@item.EventFrom.ToString("dd-MMM-yyyy HH:mm")</td>
                                    <td>@item.EventTo.ToString("dd-MMM-yyyy HH:mm")</td>
                                    <td>@item.EventVenue</td>
                                    <td>@item.CreatedOn.ToString("dd-MMM-yyyy HH:mm")</td>
                                    <td>@item.FirstName @item.LastName</td>
                                    <td>@item.Status</td>
                                    <td>
                                        <div class="btn-group">
                                            <button type="button" class="btn btn-warning btn-sm dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                                Action
                                            </button>
                                            <div class="dropdown-menu" style="font-size: small; z-index: 5; margin-left: -80px;">
                                                @if (eventType == "past")
                                                {
                                                    <a href="/admin/viewevent/@item.Id" class="dropdown-item"><i class="nav-icon fas fa-eye" style="color:cornflowerblue"></i>&nbsp; View Event</a>
                                                    <a href="#" class="dropdown-item text-danger delete-event" data-id="@item.Id"><i class="nav-icon fas fa-trash-alt" style="color:red"></i>&nbsp; Delete Event</a>
                                                }
                                                else if (eventType == "in-progress")
                                                {
                                                    <a href="/admin/viewevent/@item.Id" class="dropdown-item"><i class="nav-icon fas fa-eye" style="color:cornflowerblue"></i>&nbsp; View Event</a>
                                                    <a href="#" class="dropdown-item text-danger delete-event" data-id="@item.Id"><i class="nav-icon fas fa-trash-alt" style="color:red"></i>&nbsp; Delete Event</a>
                                                    <div class="dropdown-divider"></div>
                                                    <a href="/admin/guests/@item.Id" class="dropdown-item"><i class="nav-icon fas fa-qrcode" style="color:cornflowerblue"></i>&nbsp; Event Guest</a>
                                                    <a href="#" disabled="disabled" class="dropdown-item"><i class="nav-icon fas fa-asterisk" style="color:cornflowerblue"></i>&nbsp; QR Settings</a>
                                                    <div class="dropdown-divider"></div>
                                                    <a href="/admin/assigngatekeeper/@item.Id" disabled="disabled" class="dropdown-item"><i class="nav-icon fas fa-user" style="color:cornflowerblue"></i>&nbsp; Assign Gatekeeper</a>
                                                    <div class="dropdown-divider"></div>
                                                    <a href="/admin/GetEventAssignedOperator/@item.Id" disabled="disabled" class="dropdown-item"><i class="nav-icon fas fa-user" style="color:cornflowerblue"></i>&nbsp; Assign Operator</a>
                                                    <div class="dropdown-divider"></div>
                                                    <a href="/admin/editevent/@item.Id" class="dropdown-item"><i class="nav-icon fas fa-archive" style="color:cornflowerblue"></i>&nbsp; Archive</a>
                                                }
                                                else if (eventType == "upcoming")
                                                {
                                                    <a href="/admin/editevent/@item.Id" class="dropdown-item"><i class="nav-icon fas fa-edit" style="color:cornflowerblue"></i>&nbsp; Edit Event</a>
                                                    <a href="#" class="dropdown-item text-danger delete-event" data-id="@item.Id"><i class="nav-icon fas fa-trash-alt" style="color:red"></i>&nbsp; Delete Event</a>
                                                    <div class="dropdown-divider"></div>
                                                    <a href="/admin/viewevent/@item.Id" class="dropdown-item"><i class="nav-icon fas fa-eye" style="color:cornflowerblue"></i>&nbsp; View Event</a>
                                                    <div class="dropdown-divider"></div>
                                                    <a href="/admin/guests/@item.Id" class="dropdown-item"><i class="nav-icon fas fa-qrcode" style="color:cornflowerblue"></i>&nbsp; Event Guest</a>
                                                    <a href="/admin/QRSettings/@item.Id" class="dropdown-item"><i class="nav-icon fas fa-asterisk" style="color:cornflowerblue"></i>&nbsp; QR Settings</a>
                                                    <div class="dropdown-divider"></div>
                                                    <a href="/admin/assigngatekeeper/@item.Id" class="dropdown-item"><i class="nav-icon fas fa-user" style="color:cornflowerblue"></i>&nbsp; Assign Gatekeeper</a>
                                                    <div class="dropdown-divider"></div>
                                                    <a href="/admin/GetEventAssignedOperator/@item.Id" disabled="disabled" class="dropdown-item"><i class="nav-icon fas fa-user" style="color:cornflowerblue"></i>&nbsp; Assign Operator</a>
                                                    <div class="dropdown-divider"></div>
                                                    <a href="/admin/editevent/@item.Id" class="dropdown-item"><i class="nav-icon fas fa-archive" style="color:cornflowerblue"></i>&nbsp; Archive</a>
                                                }
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                            }
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</section>

@section Scripts {
    <script>
        $(document).ready(function () {
            $('#EventsTable').DataTable({
                "fixedHeader": false,
                "lengthChange": true,
                "searching": true,
                "ordering": true,
                "info": true,
                "autoWidth": false,
                "responsive": true,
                dom: 'lfrBtip',
                buttons: [
                    'copy', 'csv', 'excel', 'print'
                ],
                "columnDefs": [{
                    "targets": [0],
                    "visible": false,
                    "searchable": false
                }]
            });

            $('#RefreshPage').click(function () {
                window.location.reload();
            });

            $(document).on("click", ".delete-event", function (e) {
                e.preventDefault();
                var eventId = $(this).data("id");

                if (confirm("Are you sure you want to delete this event?")) {
                    $.ajax({
                        url: '/Admin/DeleteEvent/' + eventId,
                        type: 'GET',
                        success: function (response) {
                            //alert(response.message);
                            location.reload(); // Reload page to see changes since we are not using server-side processing
                        },
                        error: function (xhr) {
                            alert("Error deleting event.");
                        }
                    });
                }
            });
        });
    </script>
}
