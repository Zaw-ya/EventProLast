@model EventPro.DAL.Models.BulkOperatorEvents

@{
    Layout = "~/Views/Shared/_Admin.cshtml";
}
@using EventPro.Web.Common
<link rel="stylesheet" href="@Url.Content("~")/lte/assets/plugins/summernote/summernote-bs4.css" />
<section class="content">
    <div class="container-fluid">
    </div>
    <div class="container-fluid">

        <div class="card ">
            <form id="assignForm" method="post" asp-action="Assign" enctype="multipart/form-data">
                <div asp-validation-summary="ModelOnly" class="text-danger"></div>
                <div class="row P-3">
                    <div class="col">
                        <div class="form-group pl-2">
                            <label>Assign Events From Operator</label>
                            <select id="fromOperator" asp-items="@ViewBag.operators" asp-for="@Model.OperatorAssignedFromId" class=" form-select form-control required ">
                                <option disabled selected value="">--Select Operator--</option>
                            </select>
                        </div>
                    </div>
                    <div class="col">
                        <div class="form-group col">
                            <label>Assign Events To Operator</label>
                            <select id="toOperator" asp-items="@ViewBag.operators" asp-for="@Model.OperatorAssignedToId" class=" form-select form-control  ">
                                <option disabled selected value="">--Select Operator--</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="col">
                    <button id="assignBtn" class="btn btn-primary m-3" style="float:right; width:20%" type="submit" disabled>Assign</button>
                </div>
            </form>
        </div>

        <div class="row">
            <div class="col-md-12">
                <div class="card ">
                    <div class="container-fluid" style="padding:5px;">
                        <div class="card-body p-0">
                            <table id="assignOperatros" class="table table-bordered table-hover">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>#</th>
                                        <th>Assigned From Full Name</th>
                                        <th>Assigned From User Name</th>
                                        <th>Assigned To Full Name</th>
                                        <th>Assigned To User Name</th>
                                        <th>Assigned On</th>
                                        <th>Assigned By</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
</section>


@section Scripts {
    <script src="~/assets/plugins/datatables/js/jquery.datatables.min.js"></script>
    <script src="~/assets/plugins/datatables/js/jquery.datatables.js"></script>
    <script src="~/assets/plugins/datatables/js/datatables.bootstrap4.min.js"></script>
    <script src="~/assets/plugins/datatables/js/datatables.bootstrap4.js"></script>

    <script>
        $(document).ready(function () {

            // ── Elements ──────────────────────────────────────────────
            const fromSelect = document.getElementById("fromOperator");
            const toSelect   = document.getElementById("toOperator");
            const assignBtn  = document.getElementById("assignBtn");

            // ── Prevent selecting the same operator in both dropdowns ──
            function syncDropdowns(changed, other) {
                [...other.options].forEach(opt => {
                    opt.disabled = opt.value === "";
                });
                if (changed.value !== "") {
                    const match = [...other.options].find(opt => opt.value === changed.value);
                    if (match) {
                        match.disabled = true;
                        if (other.value === changed.value) other.selectedIndex = 0;
                    }
                }
            }

            // ── Enable Assign button only when both dropdowns are filled ──
            function toggleAssignButton() {
                assignBtn.disabled = !(fromSelect.value !== "" && toSelect.value !== "");
            }

            fromSelect.addEventListener("change", function () {
                syncDropdowns(fromSelect, toSelect);
                toggleAssignButton();
            });

            toSelect.addEventListener("change", function () {
                syncDropdowns(toSelect, fromSelect);
                toggleAssignButton();
            });

            // Init
            syncDropdowns(fromSelect, toSelect);
            syncDropdowns(toSelect, fromSelect);
            toggleAssignButton();

            // ── DataTable ─────────────────────────────────────────────
            $('#assignOperatros').DataTable({
                fixedHeader: false,
                lengthChange: true,
                searching: false,
                ordering: false,
                info: true,
                autoWidth: false,
                responsive: true,
                dom: 'lfrBtip',
                buttons: ['copy', 'csv', 'excel', 'print'],
                serverSide: true,
                processing: true,
                ajax: {
                    url: "/api/GetBulkOperatorEvents",
                    type: "POST",
                    dataType: "json"
                },
                columnDefs: [{ targets: [0], visible: false, searchable: false }],
                columns: [
                    { data: "id",                   name: "Id",                   autowidth: true, orderable: false },
                    { data: "viewNumber",            name: "ViewNumber",           autowidth: true, orderable: false },
                    { data: "assignedFromFullName",  name: "AssignedFromFullName", autowidth: true, orderable: false },
                    { data: "assignedFromUserName",  name: "AssignedFromUserName", autowidth: true, orderable: false },
                    { data: "assignedToFullName",    name: "AssignedToFullName",   autowidth: true, orderable: false },
                    { data: "assignedToUserName",    name: "AssignedToUserName",   autowidth: true, orderable: false },
                    { data: "assignedOn",            name: "AssignedOn",           autowidth: true, orderable: false },
                    { data: "assignedBy",            name: "AssignedBy",           autowidth: true, orderable: false },
                    {
                        data: null,
                        orderable: false,
                        render: function (data, type, row) {
                            return `<a onclick="releaseAssignment(${row.id})" style="cursor:pointer;" class="btn btn-danger btn-sm">&nbsp; Release</a>`;
                        }
                    }
                ]
            });

            // ── Form submit — confirmation popup ──────────────────────
            $("#assignForm").on("submit", function (e) {
                e.preventDefault();

                const fromName = fromSelect.options[fromSelect.selectedIndex].text;
                const toName   = toSelect.options[toSelect.selectedIndex].text;

                Swal.fire({
                    title: 'تأكيد التعيين',
                    html: `هل أنت متأكد من تعيين جميع الفعاليات من<br><strong>${fromName}</strong><br>إلى<br><strong>${toName}</strong>؟`,
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonText: 'نعم، تعيين',
                    cancelButtonText: 'إلغاء',
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#6c757d'
                }).then(function (result) {
                    if (!result.isConfirmed) return;

                    var formData = new FormData(document.getElementById("assignForm"));

                    $.ajax({
                        url: $("#assignForm").attr("action"),
                        type: "POST",
                        data: formData,
                        processData: false,
                        contentType: false,
                        success: function (response) {
                            if (response.success) {
                                Swal.fire({
                                    icon: 'success',
                                    title: 'تم التعيين',
                                    text: response.message,
                                    timer: 2500,
                                    showConfirmButton: false
                                });
                                fromSelect.value = "";
                                toSelect.value   = "";
                                assignBtn.disabled = true;
                            } else {
                                Swal.fire({
                                    icon: 'error',
                                    title: 'فشل',
                                    text: response.message
                                });
                            }
                            $('#assignOperatros').DataTable().ajax.reload(null, false);
                        },
                        error: function (xhr) {
                            Swal.fire({
                                icon: 'error',
                                title: 'خطأ',
                                text: xhr.responseText
                            });
                        }
                    });
                });
            });
        });

        // ── Release — confirmation popup ──────────────────────────────
        function releaseAssignment(id) {
            Swal.fire({
                title: 'تأكيد إلغاء التعيين',
                text: 'هل أنت متأكد من إلغاء تعيين هذا المشغل؟',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'نعم، إلغاء',
                cancelButtonText: 'رجوع',
                confirmButtonColor: '#d33',
                cancelButtonColor: '#6c757d'
            }).then(async function (result) {
                if (!result.isConfirmed) return;

                var data   = await fetch(`/AssigningEventsOperator/UnAssign?Id=${id}`);
                var result = await data.json();

                if (result.success) {
                    Swal.fire({
                        icon: 'success',
                        title: 'تم الإلغاء',
                        text: result.message,
                        timer: 2500,
                        showConfirmButton: false
                    });
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'فشل',
                        text: result.message
                    });
                }

                $('#assignOperatros').DataTable().ajax.reload(null, false);
            });
        }
    </script>
}
