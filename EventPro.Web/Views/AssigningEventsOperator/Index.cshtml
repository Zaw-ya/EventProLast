@model EventPro.DAL.Models.BulkOperatorEvents

@{
    Layout = "~/Views/Shared/_Admin.cshtml";
}
@using EventPro.Web.Common
<link rel="stylesheet" href="@Url.Content("~")/lte/assets/plugins/summernote/summernote-bs4.css" />
<section class="content">
    <div class="container-fluid">
    </div>
    <div class="container-fluid">

            <div class="card ">
            <form id="assignForm" method="post" asp-action="Assign" enctype="multipart/form-data">
                <div asp-validation-summary="ModelOnly" class="text-danger"></div>
                <div class="row P-3">
                    <div class="col">
                        <div class="form-group pl-2">
                            <label>Assign Events From Operator</label>
                            <select id="fromOperator" asp-items="@ViewBag.operators" asp-for="@Model.OperatorAssignedFromId" class=" form-select form-control required ">
                                <option disabled selected value="">--Select Operator--</option>
                            </select>
                        </div>
                    </div>
                    <div class="col">
                        <div class="form-group col">
                            <label>Assign Events To Operator</label>
                            <select id="toOperator" asp-items="@ViewBag.operators" asp-for="@Model.OperatorAssignedToId" class=" form-select form-control  ">
                                <option disabled selected value="">--Select Operator--</option>
                            </select>
                        </div>
                    </div>
                    <div class="col" hidden>
                        <div class="form-group col">
                            <label>Assign From</label>
                            <select class="form-select form-control select2">
                                <option disabled selected value="">--Select Category</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="col">
                    <button id="assignBtn" class="btn btn-primary m-3" style="float:right; width:20%" type="submit">Assign</button>
                </div>
        </form>
            </div>
        
        <div class="row">
            <div class="col-md-12">
                <div class="card ">

                        <div class="container-fluid" style="padding:5px;">
                            <!-- /.card-header -->
                            <div class="card-body p-0">
                                <div class="table-title">
                                </div>
                                <table id="assignOperatros" class="table table-bordered table-hover">
                                    <thead>
                                        <tr>
                                            <th>#</th>
                                            <th>#</th>
                                            <th>Assigned From Full Name</th>
                                            <th>Assigned From User Name</th>
                                            <th>Assigned To Full Name</th>
                                            <th>Assigned To User Name</th>
                                            <th>Assigned On</th>
                                            <th>Assigned By</th>
                                            <th>Action</th>
                                        </tr>
                                    </thead>

                                </table>
                            </div>
                            <!-- /.card-body -->
                        </div>
                  
                    <!-- /.card -->
                </div>
            </div>
        </div>
        
    </div>
</section>


@section Scripts {
    <script>
        $(document).ready(function () {
            $("#assignForm").on("submit", function (e) {
                e.preventDefault(); // prevent normal form submission

                var form = $(this);
                var url = form.attr("action"); // action from asp-action="Assign"
                var formData = new FormData(this); // for handling file uploads

                $.ajax({
                    url: url,
                    type: "POST",
                    data: formData,
                    processData: false, // important for FormData
                    contentType: false, // important for FormData
                    success: function (response) {
                        if (response.success == true) {
                            Swal.fire({
                                icon: "success",
                                title: "تم بنجاح",
                                text: response.message
                            });
                            let fromSelect1 = document.getElementById("fromOperator");
                            let toSelect1 = document.getElementById("toOperator");
                            let assignBtn1 = document.getElementById("assignBtn");

                            fromSelect1.value = "";
                            toSelect1.value = "";
                            assignBtn1.disabled = true;
                        }else{
                            Swal.fire({
                                icon: "error",
                                title: "خطأ",
                                text: response.message,
                                footer: ''
                            });
                        }
                        $('#assignOperatros').DataTable().ajax.reload(null, false);
                    },
                    error: function (xhr, status, error) {
                        // handle error
                        alert("Error: " + xhr.responseText);
                    }
                });
            });
        });
    </script>


    <script>
        $(document).ready(function () {
            $('#assignOperatros').DataTable({
                "fixedHeader": false,
                "lengthChange": true,
                "searching": false,
                "ordering": false,
                "info": true,
                "autoWidth": false,
                "responsive": true,
                dom: 'lfrBtip',
                buttons: [
                    'copy', 'csv', 'excel', 'print'
                ],
                "serverSide": true,
                "processing": true,
                "filter": true,
                "ajax": {
                    "url": "/api/GetBulkOperatorEvents ",
                    "type": "POST",
                    "dataType": "json"
                },
                "columnDefs": [{
                    "targets": [0],
                    "visible": false,
                    "searchable": false
                }],
                "columns": [
                    { "data": "id", "name": "Id", "autowidth": true, "orderable": false },
                    { "data": "viewNumber", "name": "ViewNumber", "autowidth": true, "orderable": false },
                    { "data": "assignedFromFullName", "name": "AssignedFromFullName", "autowidth": true, "orderable": false },
                    { "data": "assignedFromUserName", "name": "AssignedFromUserName", "autowidth": true, "orderable": false },
                    { "data": "assignedToFullName", "name": "AssignedToFullName", "autowidth": true, "orderable": false },
                    { "data": "assignedToUserName", "name": "AssignedToUserName", "autowidth": true, "orderable": false },
                    { "data": "assignedOn", "name": "AssignedOn", "autowidth": true, "orderable": false },
                    { "data": "assignedBy", "name": "AssignedBy", "autowidth": true, "orderable": false },
                    {
                        "render": function (data, type, row) {
                            return ` <td><a onclick="AssigningEventsOperator(${row.id})" style="cursor: pointer;"  class="btn btn-primary">&nbsp; Release</a></td>`
                        },
                        "orderable": false,
                        "data": null
                    }
                ]


            });
            $('#RefreshPage').click(function () {
                window.location.reload();
            });
            $('#SearchBtn').click(function () {
                dataTable.draw();
            });
        })

        async function AssigningEventsOperator(Id) {
            var data = await fetch(`/AssigningEventsOperator/UnAssign?Id=${Id}`)
            var result = await data.json();

            if (result.success) {
                Swal.fire({
                    icon: "success",
                    title: "تم بنجاح",
                    text: result.message
                });
            } else {
                Swal.fire({
                    icon: "error",
                    title: "خطأ",
                    text: result.message,
                    footer: ''
                });
            }

            $('#assignOperatros').DataTable().ajax.reload(null, false);
        }

      </script>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            let fromSelect = document.getElementById("fromOperator");
            let toSelect = document.getElementById("toOperator");

            function syncDropdowns(changed, other) {
                // Loop through all options in the "other" select
                [...other.options].forEach(opt => {
                    if (opt.value === "") {
                        // Keep the placeholder always disabled
                        opt.disabled = true;
                    } else {
                        opt.disabled = false;
                    }
                });

                // Disable the option in the other dropdown if it matches the selected value
                if (changed.value && changed.value !== "") {
                    let match = [...other.options].find(opt => opt.value === changed.value);
                    if (match) {
                        match.disabled = true;

                        // If both selects have the same value, reset the other to placeholder (no recursive event firing)
                        if (other.value === changed.value) {
                            other.selectedIndex = 0; // reset to placeholder
                        }
                    }
                }
            }

            fromSelect.addEventListener("change", function () {
                syncDropdowns(fromSelect, toSelect);
            });

            toSelect.addEventListener("change", function () {
                syncDropdowns(toSelect, fromSelect);
            });

            // Enforce placeholder disabled at startup
            syncDropdowns(fromSelect, toSelect);
            syncDropdowns(toSelect, fromSelect);
        });
    </script>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            let fromSelect = document.getElementById("fromOperator");
            let toSelect = document.getElementById("toOperator");
            let assignBtn = document.getElementById("assignBtn");

            function toggleAssignButton() {
                // enable only if both have a value (not placeholder)
                if (fromSelect.value !== "" && toSelect.value) {
                    assignBtn.disabled = false;
                } else {
                    assignBtn.disabled = true;
                }
            }

            // run on every change
            fromSelect.addEventListener("change", toggleAssignButton);
            toSelect.addEventListener("change", toggleAssignButton);

            // run once at startup
            toggleAssignButton();
        });
    </script>

    <script src="~/assets/plugins/datatables/js/jquery.datatables.min.js"></script>
    <script src="~/assets/plugins/datatables/js/jquery.datatables.js"></script>
    <script src="~/assets/plugins/datatables/js/datatables.bootstrap4.min.js"></script>
    <script src="~/assets/plugins/datatables/js/datatables.bootstrap4.js"></script>

    
}
