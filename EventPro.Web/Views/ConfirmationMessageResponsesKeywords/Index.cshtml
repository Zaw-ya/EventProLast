@{
    ViewData["Title"] = "Confirmation Responses";
    Layout = "~/Views/Shared/_Admin.cshtml";
}
@using EventPro.Web.Common
<link rel="stylesheet" href="@Url.Content("~")/lte/assets/plugins/summernote/summernote-bs4.css" />
<!-- Bootstrap JS (for modals to work) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<style>
    .form-label {
        font-size: 0.95rem;
    }

    .form-select:focus,
    .form-control:focus {
        border-color: #ffc107;
        box-shadow: 0 0 0 0.25rem rgba(255, 193, 7, 0.25);
    }
</style>
<section class="content">
    <div class="container-fluid">
    </div>
    <div class="container-fluid">
        @using (Html.BeginForm(null, null, FormMethod.Post))
        {
            <div class="card card-default color-palette-box">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="fas fa-tag"></i>
                        Filter
                    </h3>

                        <div class="col-md-2" style="float:right; margin-bottom:0px;">
                        <a href="#" style="width:100%;" data-bs-toggle="modal" data-bs-target="#addKeywordModal" class="btn btn-warning btn-sm">Add New KeyWord</a>
                        </div>
   

                </div>

                    <div class="card-body">
                        <div class="col-md-3" style="float:left">
                            <div class="form-group">
                                <label>Keyword Type</label>
                            <select onchange="selectButtonType()" id="buttonType" asp-items="ViewBag.confirmationButtonResponses" name="response" class="form-control " style="width: 100%;" data-select2-id="1" tabindex="-1" aria-hidden="true">
                                </select>
                            </div>
                        </div>
                    </div>


                <!-- /.card-body -->
            </div>
        }
        <div class="row">
            <div class="col-md-12">
                <div class="card card-warning">

                    <div class="card">
                        <div class="container-fluid" style="padding:5px">
                            <!-- /.card-header -->
                            <div class="card-body p-0">
                                <div class="table-title">
                                </div>
                                <table id="responsesButtonsKeywords" class="table table-bordered table-hover text-center">
                                    <thead>
                                        <tr>
                                            <th>Id</th>
                                            <th>Id</th>
                                            <th>Keyword Key</th>
                                            <th>language Code</th>
                                            <th>keyword Value</th>
                                            <th>Created On</th>
                                            <th>Created By</th>
                                            <th>Updated On</th>
                                            <th>Updated By</th>
                                            <th>Action</th>
                                        </tr>
                                    </thead>

                                </table>
                            </div>
                            <!-- /.card-body -->
                        </div>
                    </div>
                    <!-- /.card -->
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="addKeywordModal" tabindex="-1" aria-labelledby="addKeywordModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">

                <div class="modal-header">
                    <h5 class="modal-title" id="addKeywordModalLabel">Add New Keyword</h5>
                    <button id="AddCloseModal" type="button" class="btn btn-close" data-bs-dismiss="modal" aria-label="Close">
                        <h3 aria-hidden="true">×</h3>
                    </button>
                </div>

                <div class="modal-body">
                    <form id="addKeywordForm">
                        <div class="p-3 rounded-3 bg-light shadow-sm">

                            <!-- Keyword Key -->
                            <div class="mb-3">
                                <label for="keywordKey" class="form-label fw-semibold text-secondary">
                                    ?? Keyword Key
                                </label>
                                <select class="form-select border-2 shadow-sm" id="keywordKey" required style="border-radius: 12px;">
                                    <option selected disabled value="">Select Keyword Key</option>
                                    <option value="confirm_button">? Confirm Button</option>
                                    <option value="decline_button">? Decline Button</option>
                                    <option value="eventlocation_button">?? Event Location Button</option>
                                </select>
                            </div>

                            <!-- Language -->
                            <div class="mb-3">
                                <label for="languageCode" class="form-label fw-semibold text-secondary">
                                    ?? Language
                                </label>
                                <select class="form-select border-2 shadow-sm" id="languageCode" required style="border-radius: 12px;">
                                    <option selected disabled value="">Select Language</option>
                                    <option value="ar">???? Arabic</option>
                                    <option value="en">???? English</option>
                                </select>
                            </div>

                            <!-- Keyword Value -->
                            <div class="mb-3">
                                <label for="keywordValue" class="form-label fw-semibold text-secondary">
                                    ?? Keyword Value
                                </label>
                                <input type="text"
                                       class="form-control border-2 shadow-sm"
                                       id="keywordValue"
                                       placeholder="Enter keyword value here..."
                                       required
                                       style="border-radius: 12px;">
                            </div>

                        </div>
                        
                    </form>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary btn-sm" form="addKeywordForm">Save</button>
                </div>

            </div>
        </div>
    </div>
    <div class="modal fade" id="editKeywordModal" tabindex="-1" aria-labelledby="editKeywordModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">

                <div class="modal-header">
                    <h5 class="modal-title" id="editKeywordModalLabel">Edit Keyword</h5>
                    <button id="editCloseModal" type="button" class="btn btn-close" data-bs-dismiss="modal" aria-label="Close">
                        <h3 aria-hidden="true">×</h3>
                    </button>
                </div>

                <div class="modal-body">
                    <form id="editKeywordForm">
                        <input type="hidden" id="editId">
                        <div class="p-3 rounded-3 bg-light shadow-sm">

                            <!-- Keyword Key -->
                            <div class="mb-3">
                                <label for="keywordKey" class="form-label fw-semibold text-secondary">
                                    ?? Keyword Key
                                </label>
                                <select class="form-select border-2 shadow-sm" id="editKeywordKey" required style="border-radius: 12px;">
                                    <option selected disabled value="">Select Keyword Key</option>
                                    <option value="confirm_button">? Confirm Button</option>
                                    <option value="decline_button">? Decline Button</option>
                                    <option value="eventlocation_button">?? Event Location Button</option>
                                </select>
                            </div>

                            <!-- Language -->
                            <div class="mb-3">
                                <label for="languageCode" class="form-label fw-semibold text-secondary">
                                    ?? Language
                                </label>
                                <select class="form-select border-2 shadow-sm" id="editLanguageCode" required style="border-radius: 12px;">
                                    <option selected disabled value="">Select Language</option>
                                    <option value="ar">???? Arabic</option>
                                    <option value="en">???? English</option>
                                </select>
                            </div>

                            <!-- Keyword Value -->
                            <div class="mb-3">
                                <label for="keywordValue" class="form-label fw-semibold text-secondary">
                                    ?? Keyword Value
                                </label>
                                <input type="text"
                                       class="form-control border-2 shadow-sm"
                                       id="editKeywordValue"
                                       placeholder="Enter keyword value here..."
                                       required
                                       style="border-radius: 12px;">
                            </div>

                        </div>
                    </form>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary btn-sm" form="editKeywordForm">Save Changes</button>
                </div>

            </div>
        </div>
    </div>
    <div class="modal fade" id="deleteKeywordModal" tabindex="-1" aria-labelledby="deleteKeywordModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 rounded-4 shadow-lg">

                <!-- Header -->
                <div class="modal-header bg-gradient bg-danger text-white rounded-top-4">
                    <h5 class="modal-title fw-bold d-flex align-items-center" id="deleteKeywordModalLabel">
                        <i class="bi bi-trash3-fill me-2 fs-5"></i> Delete Keyword
                    </h5>
                    <button id="deleteCloseModal" type="button" class="btn btn-close" data-bs-dismiss="modal" aria-label="Close">
                        <h3 aria-hidden="true">×</h3>
                    </button>
                </div>

                <!-- Body -->
                <div class="modal-body text-center py-4">
                    <div class="mb-3">
                        <i class="bi bi-exclamation-triangle-fill text-danger fs-1"></i>
                    </div>
                    <p class="fs-6 text-muted">
                        Are you sure you want to permanently delete the keyword:
                    </p>
                    <h5 class="fw-bold text-danger mb-3">
                        <span id="deleteKeywordName"></span>
                    </h5>
                    <input type="hidden" id="deleteKeywordId">
                </div>

                <!-- Footer -->
                <div class="modal-footer border-0 justify-content-center pb-4">
                    <button type="button" class="btn btn-outline-secondary px-4 rounded-pill" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle me-1"></i> Cancel
                    </button>
                    <button type="button" id="confirmDeleteBtn" class="btn btn-danger px-4 rounded-pill shadow-sm">
                        <i class="bi bi-trash me-1"></i> Delete
                    </button>
                </div>

            </div>
        </div>
    </div>

</section>


@section Scripts {
    <script src="~/assets/plugins/datatables/js/jquery.datatables.min.js"></script>
    <script src="~/assets/plugins/datatables/js/jquery.datatables.js"></script>
    <script src="~/assets/plugins/datatables/js/datatables.bootstrap4.min.js"></script>
    <script src="~/assets/plugins/datatables/js/datatables.bootstrap4.js"></script>
    <script>

            $(document).ready(function () {
                $('#responsesButtonsKeywords').DataTable({
                    "fixedHeader": false,
                    "lengthChange": true,
                    "searching": true,
                    "ordering": true,
                    "info": true,
                    "autoWidth": false,
                    "responsive": true,
                    dom: 'lfrBtip',
                    buttons: [
                        'copy', 'csv', 'excel', 'print'
                    ],
                    "serverSide": true,
                    "processing": true,
                    "filter": true,
                    "ajax": {
                    "url": "/ConfirmationMessageResponsesKeywords/GetConfirmationButtons",
                        "type": "POST",
                        "dataType": "json"
                    },
                    "columnDefs": [{
                        "targets": [0],
                        "visible": false,
                        "searchable": false
                    }],
                    "columns": [
                    { "data": "id", "name": "Id", "autowidth": true, "orderable": false },
                    { "data": "counter", "name": "Id", "autowidth": true, "orderable": false },
                    { "data": "keywordKey", "name": "KeywordKey", "autowidth": true, "orderable": false },
                    { "data": "languageCode", "name": "LanguageCode", "autowidth": true, "orderable": false },
                    { "data": "keywordValue", "name": "KeywordValue", "autowidth": true, "orderable": false },
                    { "data": "createdOn", "name": "CreatedOn", "autowidth": true, "orderable": false },
                    { "data": "createdBy", "name": "CreatedBy", "autowidth": true, "orderable": false },
                    { "data": "updatedOn", "name": "UpdatedOn", "autowidth": true, "orderable": false },
                    { "data": "updatedBy", "name": "UpdatedBy", "autowidth": true, "orderable": false },
                    {
                        "render": function (data, type, row) {
                            return `<a data-bs-toggle="modal" data-bs-target="#editKeywordModal" title="Edit" class="m-3" href="#" onclick="fillEditModalWithValues(${row.id}, '${row.keywordKey.replace(/'/g, "\\'")}','${row.languageCode.replace(/'/g, "\\'")}','${row.keywordValue.replace(/'/g, "\\'")}')"><i class="nav-icon fas fa-edit" style="color:blue;"></i></a>

                                           <a data-bs-toggle="modal"
           data-bs-target="#deleteKeywordModal"
           title="Delete"
           class="m-3"
           style="cursor: pointer;"
           href="#"
                                   onclick="fillDeleteModalWithValues(${row.id}, '${row.keywordValue.replace(/'/g, "\\'")}')">
           <i class="fas fa-trash" style="color: red"></i>
        </a>`
                        }, "autowidth": true, "data": null, "orderable": false
                    },
                       
                    ]

                });
            });

         function fillDeleteModalWithValues(id,value) {
            document.getElementById('deleteKeywordId').value = id;
            document.getElementById('deleteKeywordName').textContent = value;
        }

        async function fillEditModalWithValues(id,keyword,language,value) {
            // Fill modal inputs
            document.getElementById('editId').value = id;
            document.getElementById('editKeywordKey').value = keyword;
            document.getElementById('editLanguageCode').value = language;
            document.getElementById('editKeywordValue').value = value;
        }
    </script>

    <script>
        document.getElementById('addKeywordForm').addEventListener('submit', function (e) {
            e.preventDefault();

            const data = {
                Id: 0,
                KeywordKey: document.getElementById('keywordKey').value,
                LanguageCode: document.getElementById('languageCode').value,
                KeywordValue: document.getElementById('keywordValue').value,
            };

            $.ajax({
                url: '/ConfirmationMessageResponsesKeywords/AddButtonResponse', 
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(data),
                success: function (response) {
                    Swal.fire(response.message);
                    $('#responsesButtonsKeywords').DataTable().ajax.reload(null, false);
                },
                error: function (xhr) {
                    console.error(xhr.responseText);
                    alert("??? ??? ??!");
                    $('#responsesButtonsKeywords').DataTable().ajax.reload(null, false);
                }
            });

            const modalEl = document.getElementById('AddCloseModal');
            modalEl.click();
            this.reset();
        });
    </script>

    <script>

        // Handle form submission
        document.getElementById('editKeywordForm').addEventListener('submit', async function (e) {
            e.preventDefault();

            const data = {
                Id: document.getElementById('editId').value,
                KeywordKey: document.getElementById('editKeywordKey').value,
                LanguageCode: document.getElementById('editLanguageCode').value,
                KeywordValue: document.getElementById('editKeywordValue').value
            };

            // TODO: send this to your backend via fetch()
            $.ajax({
                url: '/ConfirmationMessageResponsesKeywords/UpdateButtonResponse',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(data),
                success: function (response) {
                    Swal.fire(response.message);
                    $('#responsesButtonsKeywords').DataTable().ajax.reload(null, false);
                },
                error: function (xhr) {
                    console.error(xhr.responseText);
                    alert("??? ??? ??!");
                    $('#responsesButtonsKeywords').DataTable().ajax.reload(null, false);
                }
            });

            // Close modal after saving
            const modalEl = document.getElementById('editCloseModal');
            modalEl.click();
            this.reset();
        });
    </script>
    <script>
        const deleteModal = document.getElementById('deleteKeywordModal');
        // When user confirms delete
        document.getElementById('confirmDeleteBtn').addEventListener('click', async function () {
            const id = document.getElementById('deleteKeywordId').value;
            // Close modal after saving
            const modalEl = document.getElementById('deleteCloseModal');
            modalEl.click();

            var result = await fetch(`/ConfirmationMessageResponsesKeywords/DeleteButtonResponse?id=${id}`);
            var data = await result.json();
            Swal.fire(data.message);
            $('#responsesButtonsKeywords').DataTable().ajax.reload(null, false);
        });
    </script>
    <script>
        function selectButtonType() {
            SelectedValue = document.getElementById('buttonType').value;
            $('#responsesButtonsKeywords').DataTable().ajax.url("/ConfirmationMessageResponsesKeywords/GetConfirmationButtons?type=" + SelectedValue).load();
        }
    </script>

}
